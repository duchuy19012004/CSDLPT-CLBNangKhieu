@model IEnumerable<ClubManagement.Models.ActivityLog>

@{
    ViewData["Title"] = "Nhật ký hoạt động";
    var currentPage = (int)ViewBag.CurrentPage;
    var totalPages = (int)ViewBag.TotalPages;
    var totalRecords = (int)ViewBag.TotalRecords;
    var pageSize = (int)ViewBag.PageSize;
}

<div class="container mt-4">
    <h2><i class="bi bi-journal-text"></i> Nhật ký hoạt động hệ thống</h2>

    <!-- Bộ lọc -->
    <div class="card mb-4 mt-3">
        <div class="card-body">
            <form method="get" asp-action="Index">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Thao tác</label>
                        <select name="actionFilter" class="form-select">
                            <option value="">Tất cả</option>
                            <option value="INSERT" selected="@(ViewBag.ActionFilter == "INSERT")">INSERT</option>
                            <option value="UPDATE" selected="@(ViewBag.ActionFilter == "UPDATE")">UPDATE</option>
                            <option value="DELETE" selected="@(ViewBag.ActionFilter == "DELETE")">DELETE</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Bảng</label>
                        <select name="tableName" class="form-select">
                            <option value="">Tất cả</option>
                            <option value="CauLacBo" selected="@(ViewBag.TableName == "CauLacBo")">CauLacBo</option>
                            <option value="GiangVien" selected="@(ViewBag.TableName == "GiangVien")">GiangVien</option>
                            <option value="SinhVien" selected="@(ViewBag.TableName == "SinhVien")">SinhVien</option>
                            <option value="LopNangKhieu" selected="@(ViewBag.TableName == "LopNangKhieu")">LopNangKhieu</option>
                            <option value="BienLai" selected="@(ViewBag.TableName == "BienLai")">BienLai</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Site</label>
                        <select name="site" class="form-select">
                            <option value="">Tất cả</option>
                            <option value="SiteA" selected="@(ViewBag.Site == "SiteA")">Site A</option>
                            <option value="SiteB" selected="@(ViewBag.Site == "SiteB")">Site B</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Lọc
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Thông tin -->
    <p class="text-muted mb-3">
        @if (totalRecords > 0)
        {
            <text>Hiển thị @((currentPage - 1) * pageSize + 1) - @Math.Min(currentPage * pageSize, totalRecords) / @totalRecords bản ghi</text>
        }
        else
        {
            <text>Không có bản ghi nào</text>
        }
    </p>

    <!-- Bảng dữ liệu -->
    <div class="card">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Thời gian</th>
                        <th>Thao tác</th>
                        <th>Bảng</th>
                        <th>ID bản ghi</th>
                        <th>Site</th>
                        <th>Chi tiết</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        @foreach (var log in Model)
                        {
                            <tr>
                                <td>@log.LogId</td>
                                <td>@log.Timestamp.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                <td>
                                    @if (log.Action == "INSERT")
                                    {
                                        <span class="badge bg-success">INSERT</span>
                                    }
                                    else if (log.Action == "UPDATE")
                                    {
                                        <span class="badge bg-warning text-dark">UPDATE</span>
                                    }
                                    else if (log.Action == "DELETE")
                                    {
                                        <span class="badge bg-danger">DELETE</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@log.Action</span>
                                    }
                                </td>
                                <td>@log.TableName</td>
                                <td>@log.RecordId</td>
                                <td>
                                    @if (log.Site == "SiteA")
                                    {
                                        <span class="badge bg-primary">Site A</span>
                                    }
                                    else if (log.Site == "SiteB")
                                    {
                                        <span class="badge bg-info text-dark">Site B</span>
                                    }
                                    else
                                    {
                                        <span>@log.Site</span>
                                    }
                                </td>
                                <td><small class="text-muted">@log.Details</small></td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">Không có dữ liệu</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>


    <!-- Phân trang -->
    @if (totalPages > 1)
    {
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" asp-action="Index" 
                       asp-route-page="1"
                       asp-route-actionFilter="@ViewBag.ActionFilter"
                       asp-route-tableName="@ViewBag.TableName"
                       asp-route-site="@ViewBag.Site"
                       asp-route-fromDate="@ViewBag.FromDate"
                       asp-route-toDate="@ViewBag.ToDate">Đầu</a>
                </li>
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" asp-action="Index" 
                       asp-route-page="@(currentPage - 1)"
                       asp-route-actionFilter="@ViewBag.ActionFilter"
                       asp-route-tableName="@ViewBag.TableName"
                       asp-route-site="@ViewBag.Site"
                       asp-route-fromDate="@ViewBag.FromDate"
                       asp-route-toDate="@ViewBag.ToDate">Trước</a>
                </li>

                @for (var i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" asp-action="Index" 
                           asp-route-page="@i"
                           asp-route-actionFilter="@ViewBag.ActionFilter"
                           asp-route-tableName="@ViewBag.TableName"
                           asp-route-site="@ViewBag.Site"
                           asp-route-fromDate="@ViewBag.FromDate"
                           asp-route-toDate="@ViewBag.ToDate">@i</a>
                    </li>
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" asp-action="Index" 
                       asp-route-page="@(currentPage + 1)"
                       asp-route-actionFilter="@ViewBag.ActionFilter"
                       asp-route-tableName="@ViewBag.TableName"
                       asp-route-site="@ViewBag.Site"
                       asp-route-fromDate="@ViewBag.FromDate"
                       asp-route-toDate="@ViewBag.ToDate">Sau</a>
                </li>
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" asp-action="Index" 
                       asp-route-page="@totalPages"
                       asp-route-actionFilter="@ViewBag.ActionFilter"
                       asp-route-tableName="@ViewBag.TableName"
                       asp-route-site="@ViewBag.Site"
                       asp-route-fromDate="@ViewBag.FromDate"
                       asp-route-toDate="@ViewBag.ToDate">Cuối</a>
                </li>
            </ul>
        </nav>
    }
</div>
